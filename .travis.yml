language: c
os: linux
dist: xenial
sudo: false

addons:
  apt:
    sources:
      - sourceline: 'ppa:vriviere/ppa'
    packages:
      - cross-mint-essential
      - cflib-m68k-atari-mint

env:
  global:
    - BINTRAY_USER="mikrosk"
    # BINTRAY_API_KEY is defined in Travis Settings of freemint/freemint

# If before_install, install or before_script return a non-zero exit code, the build is errored and stops immediately.
before_install:
  - export USER=$(echo "${TRAVIS_REPO_SLUG}" | cut -d '/' -f 1)
  - export BASE_RAW_URL="https://raw.githubusercontent.com/${USER}"

  - wget -O .travis/download_prerequisities.sh "${BASE_RAW_URL}/travis-scripts/master/download_prerequisities.sh"
  - sh ./.travis/download_prerequisities.sh
  - sh ./.travis/install-udo.sh

install:
  - if [ -x .travis/install.sh ]; then ./.travis/install.sh; else true; fi

before_script:
  - . ./.travis/setup_env.sh
  - export SHORT_ID=$(git log -n1 --format="%H" | cut -c 1-3)

# If script returns a non-zero exit code, the build is failed, but continues to run before being marked as failed.
script:
  - sh ./.travis/build.sh "${PWD}/.travis/tmp" "${PWD}/.travis/out"

# The exit code of after_success, after_failure, after_script and subsequent stages do not affect the build result.
# However, if one of these stages times out, the build is marked as a failure.
after_success:
  - if [ -x .travis/after_success.sh ]; then ./.travis/after_success.sh; else true; fi
after_failure:
  - if [ -x .travis/after_failure.sh ]; then ./.travis/after_failure.sh; else true; fi

# A non-zero exit code in this phase will mark the build as errored.
before_deploy:
  - if [ -x .travis/before_deploy.sh ]; then ./.travis/before_deploy.sh; else true; fi

deploy:
  provider: script
  skip_cleanup: true
  script: sh ./.travis/deploy.sh "${PWD}/.travis/out" $encrypted_184ce553573b_key $encrypted_184ce553573b_iv
  on:
    repo: freemint/toswin2
